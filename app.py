from flask import Flask, request, abort
from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError
from linebot.models import *
import random
import os

app = Flask(__name__)

line_bot_api = LineBotApi(os.environ['CHANNEL_ACCESS_TOKEN'])
handler = WebhookHandler(os.environ['CHANNEL_SECRET'])

# 餐廳資料
data = [
    ["晚餐", "清夜", "小洞天", ""],
    ["晚餐", "清夜", "重慶酸辣粉", "紅薯粉絲＋小辣中酸其餘隨便"],
    ["晚餐", "清夜", "酸辣寶", "雞絲酸辣粉"],
    ["晚餐", "清夜", "奉餡", "韓式鍋貼"],
    ["晚餐", "清夜", "吳記蔥蔬餅", "燻雞九層塔＋招牌醬"],
    ["晚餐", "清夜", "餅丁小舖", "九層塔餅＋醬油膏"],
    ["晚餐", "清夜", "林記", "四神湯"],
    ["晚餐", "清夜", "胖易桉炸雞", "鹹酥雞、地瓜薯條＋梅粉"],
    ["晚餐", "清夜", "日荃蒸餃", "蒸餃三籠"],
    ["晚餐", "清夜", "大鼓涼皮肉夾饃", "雞肉肉夾饃"],
    ["晚餐", "清夜", "味味鴨肉麵", "鴨肉麵"],
    ["晚餐", "清夜", "sukiya", ""],
    ["晚餐", "清夜", "肯德基", ""],
    ["晚餐", "清夜", "肥仔龍無煙鐵板燒", ""],
    ["晚餐", "清夜", "紅吱吱", "雞排"],
    ["晚餐", "清夜", "哈奇客", ""],
    ["晚餐", "清夜", "杜蘭小麥", ""],
    ["晚餐", "清夜", "建新水煎包", ""],
    ["晚餐", "清夜", "蔥大爺餅舖", ""],
    ["晚餐", "清夜", "雞雞叫", ""],
    ["晚餐", "清夜", "捲捲pasta", ""],
    ["晚餐", "清夜", "粥大福", ""],
    ["晚餐", "清夜", "香港強記燒臘便當", ""],
    ["晚餐", "清夜", "we pasta", ""],
    ["晚餐", "清夜", "好口味", "百頁豆腐、櫛瓜"],
    ["晚餐", "清夜", "港島主麵", ""],
    ["晚餐", "清夜", "溫州王", ""],
    ["晚餐", "清夜", "十上食堂", ""],
    ["晚餐", "清夜", "甘泉魚麵", ""],
    ["晚餐", "清夜", "十六區和風料理", ""],
    ["晚餐", "清夜", "摩斯漢堡", ""],
    ["晚餐", "清夜", "胖老爹", ""],
    ["晚餐", "清夜", "良叔叔滷味", ""],
    ["晚餐", "清夜", "安姆士", ""],
    ["晚餐", "清夜", "黃記", ""],
    ["晚餐", "清夜", "鴨香意麵", ""],
    ["晚餐", "清夜", "清大夜市臭豆腐", ""],
    ["晚餐", "清夜", "台北迪化街大腸紅麵線", ""],
    ["晚餐", "清夜", "吉米洋食屋", ""],
    ["晚餐", "清夜", "三顧茅廬", ""],
    ["晚餐", "清夜", "牽漿店", ""],
    ["晚餐", "清夜", "吉野烤肉飯", ""],
    ["晚餐", "清夜", "懷香臭臭鍋", ""],
    ["晚餐", "清夜", "中壢牛肉麵", ""],
    ["晚餐", "清夜", "潮味決", ""],
    ["晚餐", "清夜", "大廟牛排", ""],
    ["晚餐", "清夜", "雙響丼", ""],
    ["晚餐", "清夜", "大埔鐵板燒", ""],
    ["晚餐", "清夜", "豬多好室", ""],
    ["晚餐", "清夜", "清大滷味", ""],
    ["晚餐", "清夜", "東山鴨頭", ""],
    ["晚餐", "清夜", "阿順虱目魚肚粥", ""],
    ["晚餐", "清夜", "原巷子麵", ""],
    ["晚餐", "清夜", "東家便當", ""],
    ["晚餐", "清夜", "板本章魚小丸子", ""],
    ["晚餐", "清夜", "日船章魚小丸子", ""],
    ["晚餐", "清夜", "三商巧福", ""],
    ["晚餐", "清夜", "麵匡匡拉麵堂", ""],
    ["晚餐", "清夜", "鳳荷三鮮", ""],
    ["晚餐", "清夜", "食天關東煮", ""],
    ["晚餐", "清夜", "阿宏師涼麵", ""],
    ["晚餐", "清夜", "醍醐味豬腳飯", ""],
    ["晚餐", "清夜", "永記牛肉麵", ""],
    ["晚餐", "清夜", "江之戶日式料理", ""],
    ["晚餐", "清夜", "good luck豬腳湯", ""],
    ["晚餐", "清夜", "想破頭黃金蛋炒飯", ""],
    ["晚餐", "清夜", "清大雙喜餛飩", ""],
    ["晚餐", "清夜", "饗嗑鍋精緻鍋物", ""],
    ["晚餐", "清夜", "白鬍子牛排", ""],
    ["晚餐", "清夜", "升一排骨", ""],
    ["晚餐", "清夜", "郭董脆皮臭豆腐", ""],
    ["晚餐", "清夜", "大腸蚵仔麵線", ""],
    ["晚餐", "清夜", "鳳麟粥飯麵食館", ""],
    ["晚餐", "清夜", "the campus", ""],
    ["晚餐", "清夜", "the park", ""],
    ["晚餐", "清夜", "india darbar", ""],
    ["晚餐", "清夜", "yummy yummy restaurant", ""],
    ["晚餐", "清夜", "獅子印度餐廳", ""],
    ["晚餐", "清夜", "信仰小吃鹹酥雞", ""],
    ["晚餐", "清夜", "香港銅鑼灣", ""],
    ["晚餐", "清夜", "六扇門", ""],
    ["晚餐", "清夜", "竹源現炒", ""],
    ["晚餐", "清夜", "巧捷精緻便當", ""],
    ["晚餐", "清夜", "飯丸屋", ""],
    ["晚餐", "清夜", "鐵板饄", ""],
    ["晚餐", "二餐", "SUBWAY", "6吋蜂蜜燕麥麵包配蛋沙拉"],
    ["晚餐", "二餐", "玖蔦家火山丼", "溫玉烏龍麵"],
    ["晚餐", "二餐", "太祖魷魚羹", "雞絲飯"],
    ["晚餐", "二餐", "兩兄妹", ""],
    ["晚餐", "二餐", "阿嬤的飯桶", "香酥雞排飯"],
    ["晚餐", "二餐", "隆太郎金牌燒臘", ""],
    ["晚餐", "二餐", "素怡園", "自由配"],
    ["晚餐", "二餐", "7-11交大門市", ""],
    ["晚餐", "二餐", "茗松快餐、麵食部", ""],
    ["晚餐", "一餐", "歐式自助餐", ""],
    ["晚餐", "一餐", "完顏南洋料理", ""],
    ["晚餐", "一餐", "Lala kitchen", ""],
    ["晚餐", "女二", "A華滷味", ""],
    ["晚餐", "女二", "翁記滷肉飯", ""],
    ["晚餐", "女二", "極麵道", ""],
    ["晚餐", "女二", "全美小吃店", "隨便夾"],
    ["晚餐", "女二", "天晟燒臘", ""],
    ["晚餐", "女二", "麥當勞", ""],
    ["晚餐", "女二", "全家便利商店", ""],
    ["晚餐", "研三", "李記小館", ""],
    ["晚餐", "研三", "恩雅泰式料理", ""],
    ["晚餐", "研三", "漢堡王", ""],
    ["晚餐", "研三", "全家便利商店", ""],
    ["晚餐", "研三", "7-11", ""],
    ["晚餐", "研三", "義早早午餐", ""],
    ["宵夜", "清夜", "3Q脆皮雞排", ""],
    ["宵夜", "清夜", "立晉豆花", ""],
    ["宵夜", "清夜", "開源社", ""],
    ["宵夜", "清夜", "蒜翻天", "細薯條"],
    ["宵夜", "清夜", "雞雞叫", "杏鮑菇、百頁豆腐"],
    ["宵夜", "清夜", "來來豆漿", "薯餅、燒餅油條、飯糰夾蛋"],
    ["宵夜", "清夜", "永和豆漿", "飯糰、奶茶、蛋餅夾肉"],
    ["宵夜", "清夜", "好口味", "櫛瓜、百頁豆腐、甜不辣"],
    ["宵夜", "清夜", "吳記蔥蔬餅", ""],
    ["宵夜", "清夜", "韓國無人拉麵店", ""],
    ["宵夜", "清夜", "胖老爹", ""],
    ["宵夜", "清夜", "惡魔雞排", ""],
    ["宵夜", "清夜", "白鬍子牛排", ""],
    ["宵夜", "清夜", "豬多好室", ""],
    ["宵夜", "清夜", "郭董脆皮臭豆腐", ""],
    ["宵夜", "清夜", "肥仔龍無煙鐵板燒", ""],
    ["宵夜", "清夜", "3Q脆皮雞排", ""],
    ["宵夜", "清夜", "清大夜市臭豆腐", ""],
    ["宵夜", "清夜", "台北迪化街大腸紅麵線", ""],
    ["宵夜", "清夜", "懷香臭臭鍋", ""],
    ["宵夜", "清夜", "信仰小吃鹹酥雞", ""],
    ["宵夜", "清夜", "海洋冰城", ""],
    ["宵夜", "清夜", "大廟牛排", ""],
    ["宵夜", "清夜", "紅吱吱牛排", ""],
    ["宵夜", "清夜", "the campus", ""],
    ["宵夜", "清夜", "the park", ""],
    ["宵夜", "清夜", "豬好運豬腳湯", ""],
    ["宵夜", "二餐", "7-11交大門市", ""],
    ["宵夜", "女二", "全家便利商店", ""],
    ["午餐", "研三", "7-11", ""],
    ["午餐", "研三", "奶油廚房", ""],
    ["午餐", "研三", "比司多", ""],
    ["午餐", "研三", "李記小館", ""],
    ["午餐", "研三", "恩雅泰式料理", ""],
    ["午餐", "研三", "漢堡王", ""],
    ["午餐", "研三", "全家便利商店", ""],
    ["午餐", "研三", "義早早午餐", ""],
    ["午餐", "女二", "A華滷味", ""],
    ["午餐", "女二", "翁記滷肉飯", ""],
    ["午餐", "女二", "比司多早午餐", ""],
    ["午餐", "女二", "極麵道", ""],
    ["午餐", "女二", "全美小吃店", "隨便夾"],
    ["午餐", "女二", "路易莎咖啡", "火腿起司熱壓吐司"],
    ["午餐", "女二", "天晟燒臘", ""],
    ["午餐", "女二", "麥當勞", ""],
    ["午餐", "女二", "全家便利商店", ""],
    ["午餐", "一餐", "歐式自助餐", ""],
    ["午餐", "一餐", "完顏南洋料理", ""],
    ["午餐", "一餐", "Lala kitchen", ""],
    ["午餐", "二餐", "SUBWAY", "6吋蜂蜜燕麥麵包配蛋沙拉"],
    ["午餐", "二餐", "拉亞漢堡", ""],
    ["午餐", "二餐", "玖蔦家火山丼", "溫玉烏龍麵"],
    ["午餐", "二餐", "太祖魷魚羹", "雞絲飯"],
    ["午餐", "二餐", "兩兄妹", ""],
    ["午餐", "二餐", "阿嬤的飯桶", "香酥雞排飯"],
    ["午餐", "二餐", "隆太郎金牌燒臘", ""],
    ["午餐", "二餐", "素怡園", "自由配"],
    ["午餐", "二餐", "7-11交大門市", ""],
    ["午餐", "二餐", "茗松快餐、麵食部", ""],
    ["早餐", "研三", "奶油廚房", ""],
    ["早餐", "研三", "全家便利商店", ""],
    ["早餐", "研三", "漢堡王", ""],
    ["早餐", "研三", "義早早午餐", ""],
    ["早餐", "研三", "7-11", ""],
    ["早餐", "研三", "比司多", ""],
    ["早餐", "二餐", "拉亞漢堡", ""],
    ["早餐", "二餐", "7-11交大門市", ""],
    ["早餐", "女二", "比司多早午餐", ""],
    ["早餐", "女二", "全家便利商店", ""],
    ["早餐", "女二", "路易莎咖啡", "火腿起司熱壓吐司"],
    ["早餐", "女二", "麥當勞", ""],
    ["飲料甜點", "研三", "細鳳果茶", ""],
    ["飲料甜點", "研三", "全家便利商店", ""],
    ["飲料甜點", "研三", "7-11", ""],
    ["飲料甜點", "研三", "漢堡王", ""],
    ["飲料甜點", "一餐", "軒韻手做茶飲", ""],
    ["飲料甜點", "清夜", "岩語茶", ""],
    ["飲料甜點", "清夜", "鶴茶樓", "綺夢那提"],
    ["飲料甜點", "清夜", "龜記茗品", "普洱茶、三十三茶王"],
    ["飲料甜點", "清夜", "迷客夏", "娜杯紅茶拿鐵、麥茶"],
    ["飲料甜點", "清夜", "八曜和茶", "柚香覺醒307"],
    ["飲料甜點", "清夜", "珍煮丹", ""],
    ["飲料甜點", "清夜", "飲川", "碧螺春"],
    ["飲料甜點", "清夜", "可不可熟成紅茶", "麗春紅茶"],
    ["飲料甜點", "清夜", "圈圈微森", ""],
    ["飲料甜點", "清夜", "茶湯會", "蜂蜜四季春小珍珠雅"],
    ["飲料甜點", "清夜", "黑龍會", ""],
    ["飲料甜點", "清夜", "先喝道", "金杯烏瓦那提"],
    ["飲料甜點", "清夜", "茗釀茶品", ""],
    ["飲料甜點", "清夜", "沐堤", "鐵觀音那提"],
    ["飲料甜點", "清夜", "麻古茶坊", "金萱"],
    ["飲料甜點", "清夜", "來杯果豬", ""],
    ["飲料甜點", "清夜", "Mr. Wish", ""],
    ["飲料甜點", "清夜", "coco都可", ""],
    ["飲料甜點", "清夜", "拾汣茶屋", ""],
    ["飲料甜點", "清夜", "50嵐", "紅茶拿鐵"],
    ["飲料甜點", "清夜", "五桐號", ""],
    ["飲料甜點", "清夜", "defcoffee", ""],
    ["飲料甜點", "清夜", "波波tea&艾蛋雞蛋糕", ""],
    ["飲料甜點", "清夜", "薇朵莉雅", "泡芙、雞肉捲餅"],
    ["飲料甜點", "清夜", "立晉豆花", ""],
    ["飲料甜點", "清夜", "魔豆", "仙草綜合圓+兩冰球"],
    ["飲料甜點", "清夜", "豆戀迷", ""],
    ["飲料甜點", "清夜", "海洋冰城", ""],
    ["飲料甜點", "清夜", "QQ圓", ""],
    ["飲料甜點", "清夜", "黃記", ""],
    ["飲料甜點", "清夜", "慢點吐司", ""],
    ["飲料甜點", "清夜", "middle cream蜜德奶油", ""],
    ["飲料甜點", "清夜", "新龍興蛋糕", ""],
    ["飲料甜點", "清夜", "星八克", ""],
    ["飲料甜點", "清夜", "hila step", ""],
    ["飲料甜點", "二餐", "茶壜", "雙Q百香綠"],
    ["飲料甜點", "二餐", "這家咖啡", ""],
    ["飲料甜點", "二餐", "7-11交大門市", ""],
    ["飲料甜點", "二餐", "果汁甜品吧", "豆花仙草超好吃"],
    ["飲料甜點", "二餐", "HERE SPACE", ""],
    ["飲料甜點", "女二", "CL水果大亨", "西瓜汁"],
    ["飲料甜點", "女二", "路易莎咖啡", "芒果綠"],
    ["飲料甜點", "女二", "麥當勞", ""],
    ["飲料甜點", "女二", "全家便利商店", ""]
]

emoji = [
    "d(`･∀･)b",
    "(*´∀`)~♥",
    "_(:3 」∠ )_",
    "(σ′▽‵)′▽‵)σ",
    "(⁰▿⁰)",
    "(∂ω∂)",
    "･*･:≡(　ε:)",
    "ヽ(・×・´)ゞ",
    "♥(´∀` )人",
    "(๑ơ ₃ ơ)♥",
    "(●´ω｀●)ゞ",
    "(๑´ㅁ`)",
    "o(☆Ф∇Ф☆)o",
    "✧◝(⁰▿⁰)◜✧",
    "(・ε・)",
    "(｢･ω･)｢",
    "＼(●´ϖ`●)／",
    "( *´◒`*)",
    "(♡˙︶˙♡)",
    "ᕕ ( ᐛ ) ᕗ",
    "(◍•ᴗ•◍)ゝ"
]

user_state = {}

@app.route("/callback", methods=['POST'])
def callback():
    signature = request.headers['X-Line-Signature']
    body = request.get_data(as_text=True)
    app.logger.info("Request body: " + body)
    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        abort(400)
    return 'OK'

@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    message = event.message.text
    user_id = event.source.user_id
    reply_token = event.reply_token

    if user_id not in user_state:
        user_state[user_id] = {}

    if message in ["早餐", "午餐", "晚餐", "宵夜", "飲料甜點"]:
        user_state[user_id]['meal_type'] = message
        response = "尼想在哪吃(੭ ᐕ)੭？ 一餐/二餐/女二/研三/清夜/隨便"
    elif message in ["一餐", "二餐", "女二", "研三", "清夜", "隨便"]:
        meal_type = user_state[user_id].get('meal_type')
        if not meal_type:
            response = "尼想吃神摸(´･ω･`)? (早餐/午餐/晚餐/宵夜/飲料甜點)"
        else:
            if message == "隨便":
                filtered_data = [d for d in data if d[0] == meal_type]
            else:
                filtered_data = [d for d in data if d[0] == meal_type and d[1] == message]
            
            if not filtered_data:
                response = "找不到耶( ´•̥×•̥` ) 試試其他選項吧(･8･)"
            else:
                selected_restaurant = random.choice(filtered_data)
                selected_emoji = random.choice(emoji)
                if selected_restaurant[3]:
                    response = f"就決定 4 尼ㄌ！{selected_restaurant[1]} - {selected_restaurant[2]} - {selected_restaurant[3]} {selected_emoji}"
                else:
                    response = f"就決定 4 尼ㄌ！{selected_restaurant[1]} - {selected_restaurant[2]} {selected_emoji}"
            user_state.pop(user_id)
    else:
        response = "請豪豪打字(｡ŏ_ŏ) (早餐/午餐/晚餐/宵夜/飲料甜點)"

    line_bot_api.reply_message(reply_token, TextSendMessage(text=response))
    
import os
if __name__ == "__main__":
    port = int(os.environ.get('PORT', 5000))
    app.run(host='0.0.0.0', port=port)
